<!DOCTYPE html>
<html>
<head>
    <title>S448086-AddedChangedInformationList</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_initDate:void 0,_endDate:void 0,_releaseId:void 0,_releaseName:void 0,_milestoneId:void 0,_iterationId:void 0,_iterationName:void 0,_initItems:void 0,_endItems:void 0,_searchParameter:void 0,_addedChangedParameter:void 0,items:[{xtype:"container",itemId:"header",cls:"header"},{xtype:"container",itemId:"bodyContainer",height:"90%",width:"100%",autoScroll:!0}],launch:function(){var e=this.getContext().getProject().ObjectID,t=Ext.widget("rallymilestonecombobox",{fieldLabel:"Choose Milestone",itemId:"milestonecombobox",allowClear:!0,width:300,listeners:{change:function(e){if(e.getValue()&&""!=e.getValue()&&e.valueModels.length>0){var t=e.valueModels;console.log("milestone selected",t[0].get("ObjectID")),this._milestoneId=t[0].get("ObjectID")}},ready:function(e){},scope:this}}),a=Ext.create("Rally.ui.combobox.ReleaseComboBox",{fieldLabel:"Choose Release",width:400,itemId:"releasaeComboBox",allowClear:!0,showArrows:!1,scope:this,listeners:{ready:function(e){var t=e.getRecord();this._releaseId=t.get("ObjectID"),this._releaseName=e.getRecord().get("Name")},select:function(e,t){var a=t[0];this._releaseId=a.get("ObjectID"),this._releaseName=e.getRecord().get("Name")},scope:this}}),o=Ext.create("Rally.ui.combobox.IterationComboBox",{fieldLabel:"Choose Iteration",width:400,itemId:"iterationComboBox",allowClear:!0,showArrows:!1,scope:this,listeners:{ready:function(e){var t=e.getRecord();this._iterationId=t.get("ObjectID"),this._iterationName=t.get("Name")},select:function(e,t,a){var o=t[0];this._iterationId=o.get("ObjectID"),this._iterationName=o.get("Name")},scope:this}}),r=Ext.create("Rally.ui.Button",{text:"Search",margin:"10 10 10 100",scope:this,handler:function(){this._doSearch(e,this._initDate,this._endDate)}});this.myMask=new Ext.LoadMask({msg:"Please wait...",target:this}),this.down("#header").add([{xtype:"panel",autoWidth:!0,height:180,layout:"hbox",items:[{xtype:"panel",title:"Choose date range:",flex:3,align:"stretch",autoHeight:!0,bodyPadding:10,items:[{xtype:"datefield",anchor:"100%",fieldLabel:"From",scope:this,listeners:{change:function(e,t,a){this._initDate=t.toISOString()},scope:this}},{xtype:"datefield",anchor:"100%",fieldLabel:"To",scope:this,listeners:{change:function(e,t,a){this._endDate=t},scope:this}},{xtype:"radiogroup",fieldLabel:"Choose parameter",items:[{xtype:"radiofield",id:"radio1",name:"parameter",boxLabel:"Release",padding:"0 10 0 0",inputValue:"r"},{boxLabel:"Iteration",name:"parameter",padding:"0 10 0 0",inputValue:"i",id:"radio2"},{boxLabel:"Milestone",name:"parameter",padding:"0 10 0 0",inputValue:"m",id:"radio3"}],listeners:{change:function(e,r,i){var n=r.parameter;this._searchParameter=n,console.log("value radio:",n);var l=Ext.getCmp("milestoneFieldContainer");"r"==n?(a.show(),o.hide(),t.hide(),l.hide()):"i"==n?(a.hide(),o.show(),t.hide(),l.hide()):(a.hide(),o.hide(),t.show(),l.show())},scope:this}},{xtype:"radiogroup",fieldLabel:"Choose Changed/Added",columns:2,items:[{xtype:"radiofield",id:"addedRadio",name:"addedChanged",padding:"0 10 0 0",boxLabel:"Added",inputValue:"a"},{boxLabel:"Changed",name:"addedChanged",padding:"0 10 0 0",inputValue:"c",id:"changedRario"}],listeners:{change:function(e,t,a){var o=t.addedChanged;this._addedChangedParameter=o,console.log("value radio:",o)},scope:this}}]}]},{xtype:"panel",items:[{xtype:"fieldcontainer",id:"milestoneFieldContainer",fieldLabel:"Choose Milestone",pack:"end",labelAlign:"right",items:[t]},a,o,r]}]),a.hide(),o.hide(),t.hide(),Ext.getCmp("milestoneFieldContainer").hide()},_doSearch:function(e,t,a){if(""!=t&&""!=a){var o;this.myMask.show(),console.log("loading init features",t,a),console.log("search parameter:",this._searchParameter);var r,i="=";if("m"==this._searchParameter)o="Milestones",r=this._milestoneId,this._loadInitData(e,t,a,o,i,r);else if("i"==this._searchParameter){o="Iteration",i="in";var n=this._loadIterations(e);Deft.Promise.all([n]).then({success:function(r){console.log("promises:",r);var n=r[0];this._loadInitData(e,t,a,o,i,n)},failure:function(e){console.log("error:",e)},scope:this})}else if("r"==this._searchParameter){o="Release",i="in";var l=this._loadReleases(e);Deft.Promise.all([l]).then({success:function(r){console.log("promises:",r);var n=r[0];this._loadInitData(e,t,a,o,i,n)},failure:function(e){console.log("error:",e)},scope:this})}}},_loadInitData:function(e,t,a,o,r,i){this.filtersInit=[{property:"__At",value:t},{property:"_TypeHierarchy",operator:"in",value:["Defect","HierarchicalRequirement","PortfolioItem/Feature"]},{property:"_ProjectHierarchy",value:e},{property:o,operator:r,value:i}],console.log("filters:",this.filtersInit);Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","CreatedBy","CreationDate","LeafStoryPlanEstimateTotal","LeafStoryCount","PreliminaryEstimate","PlanEstimate","PortfolioItem","ScheduleState","Children","Milestones","State","Parent","Project","PercentDoneByStoryPlanEstimate","_User","_ValidFrom","_ValidTo"],filters:this.filtersInit,autoLoad:!0,sorters:[{property:"ObjectID",direction:"ASC"}],limit:1/0,hydrate:["State","ScheduleState","Project"],listeners:{load:function(o,r,n){console.log("Init Store",o),this._initItems=r,this._loadEndData(e,t,a,i)},scope:this}})},_loadEndData:function(e,t,a,o){var r;console.log("loading end features",t,a),console.log("search parameter:",this._searchParameter);var i="=";"r"==this._searchParameter?(r="Release",i="in"):"i"==this._searchParameter?(r="Iteration",i="in"):"m"==this._searchParameter&&(r="Milestones",o=this._milestoneId),this.filtersEnd=[{property:"__At",value:this._endDate},{property:"_TypeHierarchy",operator:"in",value:["Defect","HierarchicalRequirement","PortfolioItem/Feature"]},{property:"_ProjectHierarchy",value:e},{property:r,operator:i,value:o}],console.log("filters:",this.filtersEnd);Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","CreatedBy","CreationDate","LeafStoryPlanEstimateTotal","LeafStoryCount","PreliminaryEstimate","PlanEstimate","PortfolioItem","ScheduleState","TestCase","Milestones","State","Parent","Project","PercentDoneByStoryPlanEstimate","_User","_ValidFrom","_ValidTo"],filters:this.filtersEnd,autoLoad:!0,sorters:[{property:"ObjectID",direction:"ASC"}],limit:1/0,hydrate:["State","ScheduleState","Project"],listeners:{load:function(o,r,i){console.log("End Store",o),this._endItems=r,this._findDataAdded(e,t,a)},scope:this}})},_getFeatureIds:function(e){var t=[];return _.each(e,function(e){e.get("FormattedID").startsWith("F")&&t.push(e.get("ObjectID"))}),console.log("featureIds",t),t},_loadChildStories:function(e,t,a){var o=Ext.create("Deft.Deferred");if("i"==this._searchParameter)return o.resolve();var r=[{property:"__At",value:t},{property:"_TypeHierarchy",operator:"in",value:["HierarchicalRequirement"]},{property:"_ProjectHierarchy",value:e},{property:"PortfolioItem",operator:"in",value:a}];Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","CreatedBy","CreationDate","PlanEstimate","PortfolioItem","ScheduleState","State","Parent","Project","_User","_ValidFrom","_ValidTo"],filters:r,autoLoad:!0,sorters:[{property:"ObjectID",direction:"ASC"}],limit:1/0,hydrate:["State","ScheduleState","Project"],listeners:{load:function(e,t,a){o.resolve(t),console.log("child Store",t)},scope:this}});return o.promise},_findDataAdded:function(e,t,a){var o=[],r=[],i=[],n=[],l=[],s=[],d=[],c=[],m=[];_.each(this._initItems,function(e){o.push(e.get("ObjectID"))}),_.each(this._endItems,function(e){var t,a,o;r.push(e.get("ObjectID")),""!=e.get("PortfolioItem")?t=e.get("PortfolioItem"):""!=e.get("Parent")&&(t=e.get("Parent")),""!=e.get("TestCase")&&(a=e.get("TestCase")),""!=e.get("_User")&&(o=e.get("_User")),t&&!Ext.Array.contains(d,t)&&d.push(t),a&&!Ext.Array.contains(c,a)&&c.push(a),o&&!Ext.Array.contains(m,o)&&m.push(o)});var h=[];_.each(this._endItems,function(e){Ext.Array.contains(o,e.get("ObjectID"))||e.get("FormattedID").startsWith("F")&&h.push(e.get("ObjectID"))});var p=this._loadParentNames(d),u=this._loadTestCaseNames(c),f=this._loadPreliminaryEstimates(),g=this._loadUsers(m),x=this._loadChildStories(e,t,h);Deft.Promise.all([p,u,g,f,x]).then({success:function(e){var t,a=e[0],d=e[1],c=e[2],m=e[3],h=e[4];console.log("child",h),t=h?this._endItems.concat(h):this._endItems,_.each(t,function(e){var t=e.get("ObjectID"),r=(e.get("State"),!0);if(!Ext.Array.contains(o,t)){var i;r=!1,i=e.get("FormattedID").startsWith("D")?d.get(e.get("TestCase")):a.get(""==e.get("PortfolioItem")?e.get("Parent"):e.get("PortfolioItem"));var h,p=c.get(e.get("_User"));e.get("FormattedID").startsWith("D")?(h="/defect/"+t,"Defect",s.push({_ref:h,FormattedID:e.get("FormattedID"),Parent:i,Name:e.get("Name"),PlanEstimate:e.get("PlanEstimate"),CreationDate:e.get("CreationDate"),Project:e.get("Project").Name,Owner:p,Planned:r})):e.get("FormattedID").startsWith("S")?(h="/userstory/"+t,"Story",l.push({_ref:h,FormattedID:e.get("FormattedID"),Parent:i,Name:e.get("Name"),PlanEstimate:e.get("PlanEstimate"),CreationDate:e.get("CreationDate"),Project:e.get("Project").Name,Owner:p,Planned:r})):(h="/portfolioitem/feature/"+t,"Feature",n.push({_ref:h,FormattedID:e.get("FormattedID"),Parent:i,Name:e.get("Name"),PreliminaryEstimate:m.get(e.get("PreliminaryEstimate")),LeafStoryPlanEstimateTotal:e.get("LeafStoryPlanEstimateTotal"),CreationDate:e.get("CreationDate"),Project:e.get("Project").Name,Owner:p,Planned:r}))}},this),_.each(this._initItems,function(e){var t,a=e.get("ObjectID"),o=!1;Ext.Array.contains(r,a)||(o=!0),t=e.get("FormattedID").startsWith("D")?"/defect/"+a:e.get("FormattedID").startsWith("S")?"/userstory/"+a:"/portfolioitem/feature/"+a,i.push({_ref:t,FormattedID:e.get("FormattedID"),Name:e.get("Name"),PreliminaryEstimate:e.get("PreliminaryEstimate"),LeafStoryPlanEstimateTotal:e.get("LeafStoryPlanEstimateTotal"),CreationDate:e.get("CreationDate"),Project:e.get("FormattedID"),Owner:e.get("_User"),Removed:o})},this),console.log("initItems:",i),console.log("endFeatures:",n),console.log("endStories:",l),console.log("endDefects:",s);var p=Ext.create("Rally.data.custom.Store",{data:n,pageSize:1e3}),u=Ext.create("Rally.data.custom.Store",{data:l,pageSize:1e3}),f=Ext.create("Rally.data.custom.Store",{data:s,pageSize:1e3});this.down("#bodyContainer").removeAll(!0),"i"!=this._searchParameter&&this._buildAddedFeatureGrid(p),this._buildAddedStoriesGrid(u),this._buildAddedDefectsGrid(f),this.myMask.hide()},failure:function(e){console.log("error:",e)},scope:this})},_findDataChanged:function(){},_buildAddedFeatureGrid:function(e){var t=Ext.create("Rally.ui.grid.Grid",{showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,itemId:"featureAdded",store:e,columnCfgs:[{xtype:"templatecolumn",text:"ID",dataIndex:"FormattedID",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",flex:2},{text:"Parent",dataIndex:"Parent",flex:3},{text:"PreliminaryEstimate",dataIndex:"PreliminaryEstimate",flex:1},{text:"Leaf Story Plan Estimate Total",dataIndex:"LeafStoryPlanEstimateTotal",flex:1},{text:"Date Added",dataIndex:"CreationDate",flex:2},{text:"Project",dataIndex:"Project",flex:2},{text:"Owner",dataIndex:"Owner",flex:2}]}),a=Ext.create("Ext.panel.Panel",{title:"Features Added",height:250,autoScroll:!0,layout:{type:"vbox",align:"stretch",padding:5},padding:5,itemId:"featuresAdded",items:[t]});this.down("#bodyContainer").add(a)},_buildAddedStoriesGrid:function(e){var t=Ext.create("Rally.ui.grid.Grid",{showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,itemId:"storyAdded",store:e,columnCfgs:[{xtype:"templatecolumn",text:"ID",dataIndex:"FormattedID",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",flex:2},{text:"Parent",dataIndex:"Parent",flex:3},{text:"PlanEstimate",dataIndex:"PlanEstimate",flex:1},{text:"Date Added",dataIndex:"CreationDate",flex:2},{text:"Project",dataIndex:"Project",flex:2},{text:"Owner",dataIndex:"Owner",flex:2}]}),a=Ext.create("Ext.panel.Panel",{title:"Stories Added",height:250,autoScroll:!0,layout:{type:"vbox",align:"stretch",padding:5},padding:5,itemId:"storiesAdded",items:[t]});this.down("#bodyContainer").add(a)},_buildAddedDefectsGrid:function(e){var t=Ext.create("Rally.ui.grid.Grid",{showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,itemId:"defectAdded",store:e,columnCfgs:[{xtype:"templatecolumn",text:"ID",dataIndex:"FormattedID",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",flex:2},{text:"Parent",dataIndex:"Parent",flex:3},{text:"PlanEstimate",dataIndex:"PlanEstimate",flex:1},{text:"Date Added",dataIndex:"CreationDate",flex:2},{text:"Project",dataIndex:"Project",flex:2},{text:"Owner",dataIndex:"Owner",flex:2}]}),a=Ext.create("Ext.panel.Panel",{title:"Defects Added",height:250,autoScroll:!0,layout:{type:"vbox",align:"stretch",padding:5},padding:5,itemId:"defectsAdded",items:[t]});this.down("#bodyContainer").add(a)},_loadIterations:function(e){var t=[],a=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"Iteration",autoLoad:!0,context:{projectScopeUp:!1,projectScopeDown:!0,project:null},fetch:["Description","Name","ObjectID"],limit:1/0,filters:Rally.data.QueryFilter.or([Rally.data.QueryFilter.and([{property:"Project.parent.ObjectID",value:e},{property:"name",value:this._iterationName}]),Rally.data.QueryFilter.and([{property:"Project.parent.parent.ObjectID",value:e},{property:"name",value:this._iterationName}])]),listeners:{load:function(e,o,r){if(console.log("Data:",o),o.length>0){console.log("multiple releases found:",o);var i=[];_.each(o,function(e){i.push(e.get("ObjectID"))}),t=i,console.log("iterations: ",t)}else console.log("single iteration  found, using baseiterationId:",this._iterationId),t=[this._iterationId];a.resolve(t)},scope:this}}),a.promise},_loadReleases:function(e){var t=[],a=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"Release",autoLoad:!0,context:{projectScopeUp:!1,projectScopeDown:!0,project:null},fetch:["Description","Name","ObjectID"],limit:1/0,filters:Rally.data.QueryFilter.or([Rally.data.QueryFilter.and([{property:"Project.parent.ObjectID",value:e},{property:"name",value:this._releaseName}]),Rally.data.QueryFilter.and([{property:"Project.parent.parent.ObjectID",value:e},{property:"name",value:this._releaseName}])]),listeners:{load:function(e,o,r){if(console.log("Data:",o),o.length>0){console.log("multiple releases found:",o);var i=[];_.each(o,function(e){i.push(e.get("ObjectID"))}),t=i,console.log("releases: ",t)}else console.log("single release found, using baseReleaseId:",this._releaseId),t=[this._releaseId];a.resolve(t)},scope:this}}),a.promise},_loadParentNames:function(e){var t=new Ext.util.MixedCollection,a=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Initiative",autoLoad:!0,fetch:["Name","ObjectID","FormattedID"],context:{projectScopeUp:!1,projectScopeDown:!0,project:null},filters:[{property:"ObjectID",operator:"in",value:e}],limit:1/0,listeners:{load:function(e,o,r){_.each(o,function(e){var a=e.get("FormattedID")+" - "+e.get("Name");t.add(e.get("ObjectID"),a)}),a.resolve(t)}},scope:this}),a.promise},_loadTestCaseNames:function(e){var t=Ext.create("Deft.Deferred");if(!e||0==e.length)return t.resolve(),t.promise;var a=new Ext.util.MixedCollection;return Ext.create("Rally.data.wsapi.artifact.Store",{models:["TestCase"],fetch:["Name"],limit:1/0,context:{projectScopeUp:!1,projectScopeDown:!0,project:null},filters:[{property:"ObjectID",operator:"in",value:e}]}).load({callback:function(e,o,r){r?(_.each(e,function(e){a.add(e.get("ObjectID"),e.get("Name"))}),t.resolve(a)):t.reject("Error loading testCase names.")}}),t.promise},_loadPreliminaryEstimates:function(){var e=new Ext.util.MixedCollection,t=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"PreliminaryEstimate",autoLoad:!0,fetch:["Name","ObjectID","Value"],context:{projectScopeUp:!1,projectScopeDown:!0,project:null},limit:1/0,listeners:{load:function(a,o,r){_.each(o,function(t){var a=t.get("Value");e.add(t.get("ObjectID"),a)}),t.resolve(e)}},scope:this}),t.promise},_loadUsers:function(e){var t=new Ext.util.MixedCollection,a=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"User",autoLoad:!0,fetch:["DisplayName","ObjectID"],context:{projectScopeUp:!1,projectScopeDown:!0,project:null},filters:[{property:"ObjectID",operator:"in",value:e}],limit:1/0,listeners:{load:function(e,o,r){console.log("users",o),_.each(o,function(e){var a=e.get("DisplayName");t.add(e.get("ObjectID"),a)}),a.resolve(t)}},scope:this}),a.promise}});

            Rally.launchApp('CustomApp', {
                name:"S448086-AddedChangedInformationList",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
