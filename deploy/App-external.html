<!DOCTYPE html>
<html>
<head>
    <title>S448086-AddedChangedInformationList</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_initDate:void 0,_endDate:void 0,_releaseId:void 0,_milestoneId:void 0,_iterationId:void 0,_initItems:void 0,_endItems:void 0,_searchParameter:void 0,items:[{xtype:"container",itemId:"header",cls:"header"},{xtype:"container",itemId:"bodyContainer",height:"90%",width:"100%",autoScroll:!0}],launch:function(){var e=this.getContext().getProject().ObjectID,t=Ext.widget("rallymilestonecombobox",{fieldLabel:"Choose Milestone",itemId:"milestonecombobox",allowClear:!0,width:300,listeners:{change:function(e){if(e.getValue()&&""!=e.getValue()&&e.valueModels.length>0){var t=e.valueModels;console.log("milestone selected",t[0].get("ObjectID")),this._milestoneId=t[0].get("ObjectID")}},ready:function(e){},scope:this}}),a=Ext.create("Rally.ui.combobox.ReleaseComboBox",{fieldLabel:"Choose Release",width:400,itemId:"releasaeComboBox",allowClear:!0,scope:this,listeners:{ready:function(e){var t=e.getRecord();this._releaseId=t.get("ObjectID")},select:function(e,t){var a=t[0];this._releaseId=a.get("ObjectID")},scope:this}}),o=Ext.create("Rally.ui.combobox.IterationComboBox",{fieldLabel:"Choose Iteration",width:400,itemId:"iterationComboBox",allowClear:!0,scope:this,listeners:{ready:function(e){var t=e.getRecord();this._iterationId=t.get("ObjectID")},select:function(e,t,a){var o=t[0];this._iterationId=o.get("ObjectID")},scope:this}}),r=Ext.create("Rally.ui.Button",{text:"Search",margin:"10 10 10 100",scope:this,handler:function(){this._doSearch(e,this._initDate,this._endDate)}});this.myMask=new Ext.LoadMask({msg:"Please wait...",target:this}),this.down("#header").add([{xtype:"panel",autoWidth:!0,height:120,layout:"hbox",items:[{xtype:"panel",title:"Choose date range:",flex:3,align:"stretch",autoHeight:!0,bodyPadding:10,items:[{xtype:"datefield",anchor:"100%",fieldLabel:"From",scope:this,listeners:{change:function(e,t,a){this._initDate=t.toISOString()},scope:this}},{xtype:"datefield",anchor:"100%",fieldLabel:"To",scope:this,listeners:{change:function(e,t,a){this._endDate=t},scope:this}},{xtype:"radiogroup",fieldLabel:"Choose parameter",items:[{xtype:"radiofield",id:"radio1",name:"parameter",boxLabel:"Release",inputValue:"r"},{boxLabel:"Iteration",name:"parameter",inputValue:"i",id:"radio2"},{boxLabel:"Milestone",name:"parameter",inputValue:"m",id:"radio3"}],listeners:{change:function(e,r,i){var n=r.parameter;this._searchParameter=n,console.log("value radio:",n);var l=Ext.getCmp("milestoneFieldContainer");"r"==n?(a.show(),o.hide(),t.hide(),l.hide()):"i"==n?(a.hide(),o.show(),t.hide(),l.hide()):(a.hide(),o.hide(),t.show(),l.show())},scope:this}}]}]},{xtype:"panel",items:[{xtype:"fieldcontainer",id:"milestoneFieldContainer",fieldLabel:"Choose Milestone",pack:"end",labelAlign:"right",items:[t]},a,o,r]}]),a.hide(),o.hide(),t.hide(),Ext.getCmp("milestoneFieldContainer").hide()},_doSearch:function(e,t,a){if(""!=t&&""!=a){var o,r;this.myMask.show(),console.log("loading init features",t,a),console.log("search parameter:",this._searchParameter),"r"==this._searchParameter?(o="Release",r=this._releaseId):"i"==this._searchParameter?(o="Iteration",r=this._iterationId):"m"==this._searchParameter&&(o="Milestones",r=this._milestoneId),this.filtersInit=[{property:"__At",value:t},{property:"_TypeHierarchy",operator:"in",value:["Defect","HierarchicalRequirement","PortfolioItem/Feature"]},{property:"_ProjectHierarchy",value:e},{property:o,value:r}],console.log("filters:",this.filtersInit);Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","CreatedBy","CreationDate","LeafStoryPlanEstimateTotal","LeafStoryCount","PreliminaryEstimate","PlanEstimate","PortfolioItem","ScheduleState","Milestones","State","Parent","Project","PercentDoneByStoryPlanEstimate","_User","_ValidFrom","_ValidTo"],filters:this.filtersInit,autoLoad:!0,sorters:[{property:"ObjectID",direction:"ASC"}],limit:1/0,hydrate:["State","ScheduleState","Project"],listeners:{load:function(o,r,i){console.log("Init Store",o),this._initItems=r,this._loadEndData(e,t,a)},scope:this}})}},_loadEndData:function(e,t,a){var o,r;console.log("loading end features",t,a),console.log("search parameter:",this._searchParameter),"r"==this._searchParameter?(o="Release",r=this._releaseId):"i"==this._searchParameter?(o="Iteration",r=this._iterationId):"m"==this._searchParameter&&(o="Milestones",r=this._milestoneId),this.filtersEnd=[{property:"__At",value:this._endDate},{property:"_TypeHierarchy",operator:"in",value:["Defect","HierarchicalRequirement","PortfolioItem/Feature"]},{property:"_ProjectHierarchy",value:e},{property:o,value:r}],console.log("filters:",this.filtersEnd);Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","CreatedBy","CreationDate","LeafStoryPlanEstimateTotal","LeafStoryCount","PreliminaryEstimate","PlanEstimate","PortfolioItem","ScheduleState","TestCase","Milestones","State","Parent","Project","PercentDoneByStoryPlanEstimate","_User","_ValidFrom","_ValidTo"],filters:this.filtersEnd,autoLoad:!0,sorters:[{property:"ObjectID",direction:"ASC"}],limit:1/0,hydrate:["State","ScheduleState","Project"],listeners:{load:function(e,t,a){console.log("End Store",e),this._endItems=t,this._findDataAdded()},scope:this}})},_findDataAdded:function(){var e=[],t=[],a=[],o=[],r=[],i=[],n=[],l=[],s=[];_.each(this._initItems,function(t){e.push(t.get("ObjectID"))}),_.each(this._endItems,function(e){var a,o,r;t.push(e.get("ObjectID")),""!=e.get("PortfolioItem")?a=e.get("PortfolioItem"):""!=e.get("Parent")&&(a=e.get("Parent")),""!=e.get("TestCase")&&(o=e.get("TestCase")),""!=e.get("_User")&&(r=e.get("_User")),a&&!Ext.Array.contains(n,a)&&n.push(a),o&&!Ext.Array.contains(l,o)&&l.push(o),r&&!Ext.Array.contains(s,r)&&s.push(r)});var d=this._loadParentNames(n),c=this._loadTestCaseNames(l),m=this._loadPreliminaryEstimates(),h=this._loadUsers(s);Deft.Promise.all([d,c,h,m]).then({success:function(n){var l=n[0],s=n[1],d=n[2],c=n[3];_.each(this._endItems,function(t){var a=t.get("ObjectID"),n=(t.get("State"),!0);if(!Ext.Array.contains(e,a)){var m;n=!1,m=t.get("FormattedID").startsWith("D")?s.get(t.get("TestCase")):l.get(""==t.get("PortfolioItem")?t.get("Parent"):t.get("PortfolioItem"));var h,p=d.get(t.get("_User"));t.get("FormattedID").startsWith("D")?(h="/defect/"+a,"Defect",i.push({_ref:h,FormattedID:t.get("FormattedID"),Parent:m,Name:t.get("Name"),PlanEstimate:t.get("PlanEstimate"),CreationDate:t.get("CreationDate"),Project:t.get("Project").Name,Owner:p,Planned:n})):t.get("FormattedID").startsWith("S")?(h="/userstory/"+a,"Story",r.push({_ref:h,FormattedID:t.get("FormattedID"),Parent:m,Name:t.get("Name"),PlanEstimate:t.get("PlanEstimate"),CreationDate:t.get("CreationDate"),Project:t.get("Project").Name,Owner:p,Planned:n})):(h="/portfolioitem/feature/"+a,"Feature",o.push({_ref:h,FormattedID:t.get("FormattedID"),Parent:m,Name:t.get("Name"),PreliminaryEstimate:c.get(t.get("PreliminaryEstimate")),LeafStoryPlanEstimateTotal:t.get("LeafStoryPlanEstimateTotal"),CreationDate:t.get("CreationDate"),Project:t.get("Project").Name,Owner:p,Planned:n}))}},this),_.each(this._initItems,function(e){var o,r=e.get("ObjectID"),i=!1;Ext.Array.contains(t,r)||(i=!0),o=e.get("FormattedID").startsWith("D")?"/defect/"+r:e.get("FormattedID").startsWith("S")?"/userstory/"+r:"/portfolioitem/feature/"+r,a.push({_ref:o,FormattedID:e.get("FormattedID"),Name:e.get("Name"),PreliminaryEstimate:e.get("PreliminaryEstimate"),LeafStoryPlanEstimateTotal:e.get("LeafStoryPlanEstimateTotal"),CreationDate:e.get("CreationDate"),Project:e.get("FormattedID"),Owner:e.get("_User"),Removed:i})},this),console.log("initItems:",a),console.log("endFeatures:",o),console.log("endStories:",r),console.log("endDefects:",i);var m=Ext.create("Rally.data.custom.Store",{data:o,pageSize:1e3}),h=Ext.create("Rally.data.custom.Store",{data:r,pageSize:1e3}),p=Ext.create("Rally.data.custom.Store",{data:i,pageSize:1e3});this.down("#bodyContainer").removeAll(!0),this._buildAddedFeatureGrid(m),this._buildAddedStoriesGrid(h),this._buildAddedDefectsGrid(p),this.myMask.hide()},failure:function(e){console.log("error:",e)},scope:this})},_findDataChanged:function(){},_buildAddedFeatureGrid:function(e){var t=Ext.create("Rally.ui.grid.Grid",{showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,itemId:"featureAdded",store:e,columnCfgs:[{xtype:"templatecolumn",text:"ID",dataIndex:"FormattedID",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Parent",dataIndex:"Parent",flex:3},{text:"PreliminaryEstimate",dataIndex:"PreliminaryEstimate",flex:1},{text:"Leaf Story Plan Estimate Total",dataIndex:"LeafStoryPlanEstimateTotal",flex:1},{text:"Date Added",dataIndex:"CreationDate",flex:2},{text:"Project",dataIndex:"Project",flex:2},{text:"Owner",dataIndex:"Owner",flex:2}]}),a=Ext.create("Ext.panel.Panel",{title:"Features Added",height:250,autoScroll:!0,layout:{type:"vbox",align:"stretch",padding:5},padding:5,itemId:"featuresAdded",items:[t]});this.down("#bodyContainer").add(a)},_buildAddedStoriesGrid:function(e){var t=Ext.create("Rally.ui.grid.Grid",{showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,itemId:"storyAdded",store:e,columnCfgs:[{xtype:"templatecolumn",text:"ID",dataIndex:"FormattedID",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Parent",dataIndex:"Parent",flex:3},{text:"PlanEstimate",dataIndex:"PlanEstimate",flex:1},{text:"Date Added",dataIndex:"CreationDate",flex:2},{text:"Project",dataIndex:"Project",flex:2},{text:"Owner",dataIndex:"Owner",flex:2}]}),a=Ext.create("Ext.panel.Panel",{title:"Stories Added",height:250,autoScroll:!0,layout:{type:"vbox",align:"stretch",padding:5},padding:5,itemId:"storiesAdded",items:[t]});this.down("#bodyContainer").add(a)},_buildAddedDefectsGrid:function(e){var t=Ext.create("Rally.ui.grid.Grid",{showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,itemId:"defectAdded",store:e,columnCfgs:[{xtype:"templatecolumn",text:"ID",dataIndex:"FormattedID",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Parent",dataIndex:"Parent",flex:3},{text:"PlanEstimate",dataIndex:"PlanEstimate",flex:1},{text:"Date Added",dataIndex:"CreationDate",flex:2},{text:"Project",dataIndex:"Project",flex:2},{text:"Owner",dataIndex:"Owner",flex:2}]}),a=Ext.create("Ext.panel.Panel",{title:"Defects Added",height:250,autoScroll:!0,layout:{type:"vbox",align:"stretch",padding:5},padding:5,itemId:"defectsAdded",items:[t]});this.down("#bodyContainer").add(a)},_loadParentNames:function(e){var t=new Ext.util.MixedCollection,a=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Initiative",autoLoad:!0,fetch:["Name","ObjectID","FormattedID"],context:{projectScopeUp:!1,projectScopeDown:!0,project:null},filters:[{property:"ObjectID",operator:"in",value:e}],limit:1/0,listeners:{load:function(e,o,r){_.each(o,function(e){var a=e.get("FormattedID")+" - "+e.get("Name");t.add(e.get("ObjectID"),a)}),a.resolve(t)}},scope:this}),a.promise},_loadTestCaseNames:function(e){var t=Ext.create("Deft.Deferred");if(!e||0==e.length)return t.resolve(),t.promise;var a=new Ext.util.MixedCollection;return Ext.create("Rally.data.wsapi.artifact.Store",{models:["TestCase"],fetch:["Name"],limit:1/0,context:{projectScopeUp:!1,projectScopeDown:!0,project:null},filters:[{property:"ObjectID",operator:"in",value:e}]}).load({callback:function(e,o,r){r?(_.each(e,function(e){a.add(e.get("ObjectID"),e.get("Name"))}),t.resolve(a)):t.reject("Error loading testCase names.")}}),t.promise},_loadPreliminaryEstimates:function(){var e=new Ext.util.MixedCollection,t=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"PreliminaryEstimate",autoLoad:!0,fetch:["Name","ObjectID","Value"],context:{projectScopeUp:!1,projectScopeDown:!0,project:null},limit:1/0,listeners:{load:function(a,o,r){_.each(o,function(t){var a=t.get("Value");e.add(t.get("ObjectID"),a)}),t.resolve(e)}},scope:this}),t.promise},_loadUsers:function(e){var t=new Ext.util.MixedCollection,a=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"User",autoLoad:!0,fetch:["DisplayName","ObjectID"],context:{projectScopeUp:!1,projectScopeDown:!0,project:null},filters:[{property:"ObjectID",operator:"in",value:e}],limit:1/0,listeners:{load:function(e,o,r){console.log("users",o),_.each(o,function(e){var a=e.get("DisplayName");t.add(e.get("ObjectID"),a)}),a.resolve(t)}},scope:this}),a.promise}});

            Rally.launchApp('CustomApp', {
                name:"S448086-AddedChangedInformationList",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
